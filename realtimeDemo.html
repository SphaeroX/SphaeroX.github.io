<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>OpenAI Realtime WebSocket Demo</title>
</head>

<body>
    <h1>OpenAI Realtime WebSocket Demo</h1>

    <label for="apiKey">API Key:</label>
    <input type="text" id="apiKey" placeholder="OPENAI_API_KEY" /><br><br>

    <label for="orgId">Organization ID (optional):</label>
    <input type="text" id="orgId" placeholder="OPENAI_ORG_ID" /><br><br>

    <label for="projectId">Project ID (optional):</label>
    <input type="text" id="projectId" placeholder="OPENAI_PROJECT_ID" /><br><br>

    <button id="connectBtn">Verbinden</button>

    <hr>
    <label for="userText">Nachricht:</label>
    <input type="text" id="userText" placeholder="Dein Text..." />
    <button id="sendBtn">Senden</button>

    <h3>Antwort (Text):</h3>
    <div id="responseText"></div>

    <script>
        // comments in English
        let ws = null;

        // Simple connect using the snippet from your request
        document.getElementById("connectBtn").onclick = () => {
            const OPENAI_API_KEY = document.getElementById("apiKey").value.trim();
            const OPENAI_ORG_ID = document.getElementById("orgId").value.trim();
            const OPENAI_PROJECT_ID = document.getElementById("projectId").value.trim();

            if (!OPENAI_API_KEY) {
                alert("Bitte einen API Key eingeben!");
                return;
            }

            // Construct the subprotocols array
            const protocols = [
                "realtime",
                "openai-insecure-api-key." + OPENAI_API_KEY,
                "openai-beta.realtime-v1"
            ];
            // Append optional org and project if vorhanden
            if (OPENAI_ORG_ID) {
                protocols.push("openai-organization." + OPENAI_ORG_ID);
            }
            if (OPENAI_PROJECT_ID) {
                protocols.push("openai-project." + OPENAI_PROJECT_ID);
            }

            // Connect with the given snippet
            ws = new WebSocket(
                "wss://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17",
                protocols
            );

            ws.onopen = () => {
                console.log("Connected to server.");
                alert("WebSocket Verbindung hergestellt!");
            };

            ws.onmessage = (event) => {
                // Just log the raw event for demo
                console.log("Message from server:", event.data);

                // If you'd like to handle text deltas, parse & check event type
                const msg = JSON.parse(event.data);
                if (msg.type === "response.text.delta") {
                    document.getElementById("responseText").textContent += msg.delta;
                } else if (msg.type === "response.text.done") {
                    document.getElementById("responseText").textContent += msg.text + "\n";
                }
                // ...handle other events as needed...
            };

            ws.onerror = (err) => {
                console.error("WebSocket error:", err);
                alert("Fehler bei der WebSocket-Verbindung (siehe Konsole).");
            };

            ws.onclose = () => {
                console.log("WebSocket closed.");
                alert("WebSocket Verbindung geschlossen!");
            };
        };

        // Send a simple user message and request a response
        document.getElementById("sendBtn").onclick = () => {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert("WebSocket nicht verbunden!");
                return;
            }
            const text = document.getElementById('userText').value.trim();
            if (!text) {
                alert("Bitte Text eingeben!");
                return;
            }
            // Clear displayed text
            document.getElementById("responseText").textContent = "";

            // 1) Create a user message in the conversation
            const userMsgId = "msg_" + Date.now();
            const createItemEvent = {
                event_id: "event_" + Date.now(),
                type: "conversation.item.create",
                previous_item_id: null,
                item: {
                    id: userMsgId,
                    type: "message",
                    role: "user",
                    content: [
                        {
                            type: "input_text",
                            text: text
                        }
                    ]
                }
            };
            ws.send(JSON.stringify(createItemEvent));

            // 2) Ask the model to respond
            const createResponseEvent = {
                event_id: "event_" + (Date.now() + 1),
                type: "response.create",
                response: {
                    modalities: ["text"], // just text for simplicity
                    instructions: "Bitte antworte hilfreich und kurz."
                    // override other parameters as needed
                }
            };
            ws.send(JSON.stringify(createResponseEvent));
        };
    </script>
</body>

</html>