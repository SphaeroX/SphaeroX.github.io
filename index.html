<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mond-Finder</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }
      #video-container {
        position: relative;
        width: 100vw;
        height: 100vh;
      }
      #camera-feed {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      #overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
      #info {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div id="video-container">
      <video id="camera-feed" autoplay playsinline></video>
      <canvas id="overlay"></canvas>
      <div id="info">Standort wird ermittelt...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script>
      let lat, lon, heading, pitch, roll;
      const video = document.getElementById("camera-feed");
      const overlay = document.getElementById("overlay");
      const ctx = overlay.getContext("2d");
      const info = document.getElementById("info");

      // Kamera starten
      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          video.srcObject = stream;
        } catch (err) {
          console.error("Kamera-Fehler:", err);
          info.textContent = "Kamera konnte nicht gestartet werden.";
        }
      }

      // GPS-Position ermitteln
      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(updatePosition, handleLocationError);
        } else {
          info.textContent = "Geolocation wird nicht unterstützt.";
        }
      }

      function updatePosition(position) {
        lat = position.coords.latitude;
        lon = position.coords.longitude;
        updateMoonPosition();
      }

      function handleLocationError(error) {
        console.error("Standort-Fehler:", error);
        info.textContent = "Standort konnte nicht ermittelt werden.";
      }

      // Mondposition berechnen
      function updateMoonPosition() {
        const moonPosition = SunCalc.getMoonPosition(new Date(), lat, lon);
        const azimuth = (moonPosition.azimuth * 180) / Math.PI;
        const altitude = (moonPosition.altitude * 180) / Math.PI;
        info.textContent = `Mond: Azimut ${azimuth.toFixed(2)}°, Höhe ${altitude.toFixed(2)}°`;
        drawOverlay(azimuth, altitude);
      }

      // Overlay zeichnen
      function drawOverlay(moonAzimuth, moonAltitude) {
        ctx.clearRect(0, 0, overlay.width, overlay.height);
        const centerX = overlay.width / 2;
        const centerY = overlay.height / 2;

        // Kompass-Pfeil zeichnen
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate((heading * Math.PI) / 180);
        ctx.beginPath();
        ctx.moveTo(0, -50);
        ctx.lineTo(-10, 0);
        ctx.lineTo(10, 0);
        ctx.closePath();
        ctx.fillStyle = "rgba(255, 0, 0, 0.7)";
        ctx.fill();
        ctx.restore();

        // Mond-Position als Text anzeigen
        const relativeAzimuth = (moonAzimuth - heading + 360) % 360;
        const horizontalPosition = relativeAzimuth < 90 || relativeAzimuth > 270 ? "rechts" : "links";
        const verticalPosition = moonAltitude > 0 ? "hoch" : "runter";

        ctx.font = "20px Arial";
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.fillText(`Mond: ${horizontalPosition}, ${verticalPosition}`, centerX, overlay.height - 30);
      }

      // Bewegungssensoren
      function handleOrientation(event) {
        heading = event.alpha; // Kompass-Richtung
        pitch = event.beta; // Neigung vorne/hinten
        roll = event.gamma; // Neigung links/rechts
        updateMoonPosition();
      }

      // Initialisierung
      function init() {
        startCamera();
        getLocation();
        window.addEventListener("deviceorientation", handleOrientation);

        // Canvas-Größe anpassen
        function resizeCanvas() {
          overlay.width = video.clientWidth;
          overlay.height = video.clientHeight;
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        // Regelmäßige Aktualisierung
        setInterval(updateMoonPosition, 1000);
      }

      init();
    </script>
  </body>
</html>
