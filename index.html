<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sky Tracker App</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
      }
      #cameraView {
        position: relative;
        width: 100%;
        height: 100%;
      }
      #overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px;
        font-family: Arial, sans-serif;
      }
      #targetSelect {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 10px;
      }
      .guide {
        position: absolute;
        background-color: blue;
        opacity: 0.5;
      }
      #leftGuide,
      #rightGuide {
        width: 20px;
        height: 100%;
        top: 0;
      }
      #topGuide,
      #bottomGuide {
        width: 100%;
        height: 20px;
        left: 0;
      }
      #leftGuide {
        left: 0;
      }
      #rightGuide {
        right: 0;
      }
      #topGuide {
        top: 0;
      }
      #bottomGuide {
        bottom: 0;
      }
    </style>
  </head>
  <body>
    <video id="cameraView" autoplay playsinline></video>
    <div id="overlay"></div>
    <select id="targetSelect">
      <option value="moon">Moon</option>
      <option value="mercury">Mercury</option>
      <option value="venus">Venus</option>
      <option value="mars">Mars</option>
      <option value="jupiter">Jupiter</option>
      <option value="saturn">Saturn</option>
      <option value="uranus">Uranus</option>
      <option value="neptune">Neptune</option>
    </select>
    <div id="leftGuide" class="guide"></div>
    <div id="rightGuide" class="guide"></div>
    <div id="topGuide" class="guide"></div>
    <div id="bottomGuide" class="guide"></div>

    <script src="https://unpkg.com/astronomy-engine/astronomy-engine.js"></script>
    <script>
      const cameraView = document.getElementById("cameraView");
      const overlay = document.getElementById("overlay");
      const targetSelect = document.getElementById("targetSelect");
      const guides = {
        left: document.getElementById("leftGuide"),
        right: document.getElementById("rightGuide"),
        top: document.getElementById("topGuide"),
        bottom: document.getElementById("bottomGuide"),
      };

      let currentPosition = null;
      let targetPosition = null;
      let target = 'moon';

      function startCamera() {
        navigator.mediaDevices
          .getUserMedia({ video: { facingMode: "environment" } })
          .then((stream) => {
            cameraView.srcObject = stream;
          })
          .catch((error) => {
            console.error("Error accessing camera:", error);
          });
      }

      function getLocation() {
        return new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              if (position.coords.accuracy <= 100) {
                resolve(position.coords);
              }
            },
            (error) => reject(error),
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        });
      }

      function calculateTargetPosition(target, latitude, longitude) {
        const observer = Astronomy.MakeObserver(latitude, longitude, 0);
        const date = new Date();
        let position;

        switch(target) {
          case 'mercury':
            position = Astronomy.Equator('Mercury', date, observer, true, true);
            break;
          case 'venus':
            position = Astronomy.Equator('Venus', date, observer, true, true);
            break;
          case 'mars':
            position = Astronomy.Equator('Mars', date, observer, true, true);
            break;
          case 'jupiter':
            position = Astronomy.Equator('Jupiter', date, observer, true, true);
            break;
          case 'saturn':
            position = Astronomy.Equator('Saturn', date, observer, true, true);
            break;
          case 'uranus':
            position = Astronomy.Equator('Uranus', date, observer, true, true);
            break;
          case 'neptune':
            position = Astronomy.Equator('Neptune', date, observer, true, true);
            break;
          case 'moon':
          default:
            position = Astronomy.Equator('Moon', date, observer, true, true);
            break;
        }

        const horizontal = Astronomy.Horizon(date, observer, position.ra, position.dec, 'normal');
        return {
          azimuth: horizontal.azimuth,
          altitude: horizontal.altitude,
        };
      }

      function updateOverlay(compass, tilt, targetDirection) {
        overlay.innerHTML = `
          Compass: ${compass.toFixed(2)}째<br>
          Tilt: ${tilt.toFixed(2)}째<br>
          Target Direction: Azimuth: ${targetDirection.azimuth.toFixed(2)}째, Altitude: ${targetDirection.altitude.toFixed(2)}째
        `;
      }

      function updateGuides(deviceOrientation, targetPosition) {
        const azimuthDiff = targetPosition.azimuth - deviceOrientation.alpha;
        const altitudeDiff = targetPosition.altitude - deviceOrientation.beta;

        guides.left.style.display = azimuthDiff < -5 ? "block" : "none";
        guides.right.style.display = azimuthDiff > 5 ? "block" : "none";
        guides.top.style.display = altitudeDiff > 5 ? "block" : "none";
        guides.bottom.style.display = altitudeDiff < -5 ? "block" : "none";
      }

      window.addEventListener("deviceorientation", (event) => {
        if (currentPosition && targetPosition) {
          updateOverlay(event.alpha, event.beta, targetPosition);
          updateGuides(event, targetPosition);
        }
      });

      targetSelect.addEventListener("change", (event) => {
        target = event.target.value;
      });

      async function init() {
        startCamera();
        try {
          currentPosition = await getLocation();
          setInterval(() => {
            targetPosition = calculateTargetPosition(target, currentPosition.latitude, currentPosition.longitude);
          }, 1000);
        } catch (error) {
          console.error("Error getting location:", error);
        }
      }

      init();
    </script>
  </body>
</html>
